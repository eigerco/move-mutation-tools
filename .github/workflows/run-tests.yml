name: Basic test run

on:
  push:
  #   branches: [ main ]
  #   paths:
  #     - Cargo.toml
  #     - Cargo.lock
  #     - move-mutator/**
  #     - move-spec-test/**
  #     - move-mutation-test/**
  #     - .github/workflows/run-tests.yml
  # pull_request:
  #   branches: [ main ]
  #   paths:
  #     - Cargo.toml
  #     - Cargo.lock
  #     - move-mutator/**
  #     - move-spec-test/**
  #     - move-mutation-test/**
  #     - .github/workflows/run-tests.yml

env:
  CARGO_TERM_COLOR: always

jobs:
  basic-test-run:
    runs-on: self-hosted
    name: Basic ci-check for tests
    steps:
      - uses: actions/checkout@v4

      - name: Get aptos-core
        uses: actions/checkout@v4
        with:
          repository: aptos-labs/aptos-core
          path: aptos-core

      - name: Install related tools and prover dependencies
        shell: bash
        run: aptos-core/scripts/dev_setup.sh -b -p -r -y -P -t -k

      - name: Prepare move prover tooling.
        shell: bash
        run: |
          echo 'Z3_EXE='/home/$USER/bin/z3 | tee -a $GITHUB_ENV
          echo 'CVC5_EXE='/home/$USER/bin/cvc5 | tee -a $GITHUB_ENV
          echo 'DOTNET_ROOT='/home/$USER/.dotnet/ | tee -a $GITHUB_ENV
          echo 'BOOGIE_EXE='/home/$USER/.dotnet/tools/boogie | tee -a $GITHUB_ENV
          echo 'MVP_TEST_ON_CI'='1' | tee -a $GITHUB_ENV
          echo "/home/$USER/bin" | tee -a $GITHUB_PATH
          echo "/home/$USER/.dotnet" | tee -a $GITHUB_PATH
          echo "/home/$USER/.dotnet/tools" | tee -a $GITHUB_PATH

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install nextest
        uses: taiki-e/install-action@nextest

      - name: Run normal tests in the release mode due to test duration speed bump.
        run: RUSTFLAGS="--cfg tokio_unstable" cargo nextest run -r --profile ci
